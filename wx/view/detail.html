<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
    <meta http-equiv="Content-Type"  content="multipart/form-data; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>露露星球</title>
    <link rel="stylesheet" href="../css/weui.min.css">
    <link rel="stylesheet" href="../lib/layer/mobile/need/layer.css">
    <link rel="stylesheet" href="../lib/bootstrap-3.3.7-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/regist.css">
    <link rel="stylesheet" href="../css/common.css?v=1.0">
    <link rel="stylesheet" href="../css/index.css?v=1.0">
</head>

<body>
<div class="containerOut">
    <div class="headerBar"></div>
    <div class="contentBox containerInner">
        <div class="baseInfo">
            <p class="title" style="text-align: center;font-family: Malayalam MN;" id="productDescription"></p>
            <div class="formItem">
                <p class="labTitle" style="text-align: center" ><span class="isRequired">*</span >&nbsp;<label id="productName"></label></p>
                <!--<input class="placeholderText companyName" type="text" placeholder="请输入公司名称">-->
                <p class="labTitle" style="text-align: center" id="createTime"><span class="isRequired">*</span>&nbsp;</p>

            </div>
        <div class="tipBox">
            <p class="tipTitle">温馨提示</p><br>
            <!--<p class="tipText">请把以下清单文件邮寄到聚雕网：</p>-->
            <p class="tipText" style="color: red">1、如有【不中退款】标示，退款到账号余额！没有则不退款！</p>
            <p class="tipText"style="color: red">2、如您觉得消息过多打扰到您，可以去消息订阅界面，取消订阅！</p>
            <p class="tipText" style="color: red">3、如在公众号遇到问题，请联系客服：luluxingqiu1</p>
            <p class="tipText"style="color: red">4、如果走丢，请访问luluxingqiu.com</p>

            <!--<p class="tipText">5、法人个人银行U盾、密码。</p>-->
            <!--<p class="tipText">办理时间：收到资料后10个工作日左右。</p>-->
        </div>
    </div>

</div>

    <div class="paymentBox">
            <span class="payInfo">
                订单金额 : <span class="RMB_flag" >￥</span><span class="payAmount"></span>
            </span>
        <span class="payInfo">
                <span class="RMB_flag" id="productPrice"></span><span class="payAmount"></span>
            </span>
        <a href="javascript:void(0)" class="fr nextBtn paymentBtn">下一步</a>
    </div>


    </div>
</body>
</html>

<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script src="../js/jQuery/jquery-3.4.0.js"></script>
<script src="../lib/layer/layer.js"></script>
<script src="../js/index.js?v=1.1"></script>
<script>
    var productIcon="";
    var orderId="";
    var para = window.location.search;
    var product="";
//    var product = para.split("=")[1]
    console.log(para.split("=")[0])
    if(para.split("=")[0]=="?productId"){
         product = para.split("=")[1]
        sessionStorage.clear();
        sessionStorage.setItem("product",product);
        console.log(sessionStorage.getItem("product"))
    }

    function created() {
        //如果url里有openid, 设置进cookie
        var openid = null;
//        var product = null;
        var getRequest = GetRequest();
//        product = getRequest.productId;
        if (getRequest.openid) {
            openid = getRequest.openid;
            console.log(openid)
            if (typeof openid !== 'undefined') {
                var exp = new Date();
                exp.setTime(exp.getTime() + 7200 * 1000);//过期时间60分钟
                document.cookie = 'openid=' + openid + ";expires=" + exp.toGMTString();
            }

        }
//        if (getRequest.product) {
//            product = getRequest.product;
//            console.log(product)
//            if (typeof product !== 'undefined') {
//                var exp = new Date();
//                exp.setTime(exp.getTime() + 3600 * 1000);//过期时间60分钟
//                document.cookie = 'product=' + product + ";expires=" + exp.toGMTString();
//            }
//
//        }
//    获取openidhttp://127.0.0.1/view/detail.html?productId=3encodeURIComponent(config.sellUrl + '/#/')
        if(getCookie('openid') == null) {
            location.href = baseUrl+'/sell/wechat/authorize?returnUrl='+baseUrl+"/view/detail.html";
        }
    }
    created();
    //获取页面请求路径中的参数
    function GetRequest() {
        console.log("location.search"+location.search)
        var url = location.search; //获取url中"?"符后的字串
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for (var i = 0; i < strs.length; i++) {
                theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
            }
        }
        return theRequest;
    }
    $(function() {
        $.ajax({
            url: baseUrl+'/sell/buyer/product/detail',
            type: 'get',
            data:{"productId":sessionStorage.getItem("product")},
            success: function(res){
                console.log(res)
                $('#productDescription').text(res.data.productDescription)
                $('#productName').text(res.data.productName)
                $('#createTime').text(formatDate(res.data.createTime))
                $('#productPrice').text(res.data.productPrice)
                productIcon=res.data.productIcon
            }
        })


        $('#listBox').on('click','li>a',function(){
            var loginData= JSON.parse(localStorage.getItem('loginData'));
            var tokenFlag;
            var requestData= {};
            var that= this;
            if(loginData == null) {
                window.location.href= 'http://judiaowang.cn/app/view/partnerLogin.html?ids=1012'
                return false;
            }else {
                tokenFlag= loginData.token;
                requestData= {token:tokenFlag}
                function toTarget() {
                    var hrefRoot= $(that).attr('hrefs')
                    window.location.href= 'http://judiaowang.cn/app'+hrefRoot
                }
                isLogin(requestData,toTarget)
            }

        })

    })
    function formatDate(date) {
        var date = new Date(date);
        var YY = date.getFullYear() + '-';
        var MM = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
        var DD = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate());
        var hh = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
        var mm = (date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes()) + ':';
        var ss = (date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds());
        return YY + MM + DD +" "+hh + mm + ss;
    }
    function getCookie(name) {
        var arr;
        var reg = new RegExp('(^| )' +name+"=([^;]*)(;|$)");
        if(arr=document.cookie.match(reg))
            return unescape(arr[2]);
        else
            return null;
    }
        $('.paymentBox .paymentBtn').on('click',function(){
//            layer.msg('功能调试中...业务办理请联系客服');
//            window.location.href= '../view/details.html?productIcon='+productIcon+''
            $('.paymentBox .paymentBtn').attr("disabled","disabled");
            if($('#productPrice').text()<0.1){
                console.log("---------------------------------------!!!!!!!!!!!!!!!!!!!!!!!!!!!")
                console.log($('#productPrice').text())
                location.href=baseUrl+'/view/details.html?productIcon='+productIcon;
            }
                const ERR_OK = 0;
               $.ajax({
                   url: baseUrl+'/sell/buyer/order/create',
                   type: 'POST',
                   data:{"productId":sessionStorage.getItem("product"),"openid": getCookie('openid')},
                   success: function(res){
                                    orderId=res.data.orderId;
                       $.ajax({
                           url: baseUrl+'/sell/buyer/order/payStatus',
                           type: 'POST',
                           data:{"orderId":sessionStorage.getItem("product"),"openid": getCookie('openid')},
                           success: function(res){
//                               alert("true"==res.da?ta)
                               if("true"==res.data){
                                   $.ajax({
                                       url: baseUrl+'/sell/pay/create',
                                       type: 'POST',
                                       data:{"orderId":orderId,"openid": getCookie('openid'),"returnUrl":baseUrl+'/view/details.html'},
                                       dataType:"json",
//                            contentType:"application/json",
                                       success: function(res){
                                           console.log(res)
//                                           alert(res.data.package)
                                           var payResponse=res.data;
                                           function onBridgeReady(){
                                               WeixinJSBridge.invoke(
                                                       'getBrandWCPayRequest', {
                                                           "appId":payResponse.appId,     //公众号名称，由商户传入
                                                           "timeStamp":payResponse.timeStamp,         //时间戳，自1970年以来的秒数
                                                           "nonceStr":payResponse.nonceStr, //随机串
                                                           "package":payResponse.package,
                                                           "signType":"MD5",         //微信签名方式：
                                                           "paySign":payResponse.paySign //微信签名
                                                       },
                                                       function(res){
                                                           if(res.err_msg == "get_brand_wcpay_request:ok" ) {
                                                               console.log("支付成功..........")
                                                               $.ajax({
                                                                   url: baseUrl+'/sell/buyer/order/PushpayStatus',
                                                                   type: 'post',
                                                                   data:{"orderId":orderId},
                                                                   success: function(res){
                                                                   }
                                                               })
                                                               location.href=baseUrl+'/view/details.html?productIcon='+productIcon;
                                                           }else if(res.err_msg == "get_brand_wcpay_request:cancel") {
                                                               $('.paymentBox .paymentBtn').removeAttr("disabled");
//                                                   alert('支付过程中用户取消！');
                                                           }else if(res.err_msg == "get_brand_wcpay_request:fail") {
                                                               $('.paymentBox .paymentBtn').removeAttr("disabled");
//                                                   alert('支付失败');
                                                           }else {
                                                               $('.paymentBox .paymentBtn').removeAttr("disabled");
//                                                   alert('未知异常');
                                                           }

                                                       }
                                               );
                                           }
                                           if (typeof WeixinJSBridge == "undefined"){
                                               if( document.addEventListener ){
                                                   document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                                               }else if (document.attachEvent){
                                                   document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                                                   document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                                               }
                                           }else{
                                               onBridgeReady();
                                           }



                                       }
                                   })
                               }else {
                                   location.href=baseUrl+'/view/details.html?productIcon='+productIcon;

                               }
                           }
                       })
//                        wechatPay1(res.data.orderId)
                   }
               })

        })





</script>